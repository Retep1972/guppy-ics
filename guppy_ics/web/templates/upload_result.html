{% extends "base.html" %}

{% block title %}Guppy ICS – PCAP Result{% endblock %}

{% block content %}
<body>
    <h1>PCAP Analysis Result</h1>

    <h2>Summary</h2>
    <pre>{{ summary }}</pre>

    <h3>Assets</h3>
        <div class="legend">
        <strong>Asset visibility:</strong>
        <ul class="legend-list">
            <li>
                <span class="badge badge-green">Observed (IP)</span>
                Device was directly observed communicating at IP level
            </li>
            <li>
                <span class="badge badge-blue">Observed (L2 only)</span>
                Device was directly observed at Ethernet level (e.g. PROFINET), no IP traffic seen
            </li>
            <li>
                <span class="badge badge-gray">Inferred</span>
                Device was not directly observed, but inferred from network structure or identity links
            </li>
        </ul>
    </div>
    <ul class="asset-list">
    {% for asset in assets %}
        <li class="asset-item">
            <strong>{{ asset.label }}</strong>

            {# --- ROLE BADGE --- #}
            {% if asset.role %}
                <span class="badge badge-role badge-role-{{ asset.role }}">
                    {{ asset.role }}
                </span>
            {% endif %}

            {# --- VISIBILITY BADGE (NEW) --- #}
            {% if asset.visibility_label %}
                <span class="badge badge-{{ asset.visibility_color }}">
                    {{ asset.visibility_label }}
                </span>
            {% endif %}

            <br>

            <span class="muted">
                Protocols: {{ asset.protocols | join(", ") }}
            </span>

            <br>

            <span class="muted">
                Identifiers:
                {% for id_type, values in asset.identifiers.items() %}
                    <strong>{{ id_type | upper }}</strong>:
                    {{ values | join(", ") }}
                    {% if not loop.last %}|{% endif %}
                {% endfor %}
            </span>
        </li>
    {% endfor %}
    </ul>

    <h3>Communications</h3>
    <ul class="comm-list">
    {% for comm in communications %}
        <li class="comm-item">
            <span class="badge badge-{{ comm.protocol }}">
                {{ comm.protocol }}
            </span>

            {% if comm.function %}
                <span class="badge badge-function">
                    {{ comm.function }}
                </span>
            {% endif %}
            
            {% if comm.metadata and comm.metadata.snmp_version %}
                <span class="badge badge-snmp">
                    SNMP {{ comm.metadata.snmp_version | upper }}
                </span>
            {% endif %}

            <br>
            {{ comm.src_label }}
            {% if comm.metadata and comm.metadata.src_port is defined and comm.src_ip %}
                <span class="muted">
                    (IP: {{ comm.src_ip }} | port: {{ comm.metadata.src_port }})
                </span>
            {% endif %} 
            
            → 
            
            {{ comm.dst_display or comm.dst_label }}
            {% if comm.metadata and comm.metadata.dst_port is defined and comm.dst_ip %}
                <span class="muted">
                    (IP: {{ comm.dst_ip }} | port: {{ comm.metadata.dst_port }})
                </span>
            {% endif %}
        </li>
    {% endfor %}
    </ul>

    <h3>Topology</h3>

    {% if topology %}
    <ul class="topology-tree">
    {% for src, edges in topology.items() %}
        <li class="topology-node">
            <span class="topology-root">{{ src }}</span>
            <ul>
            {% for edge in edges %}
                <li class="topology-edge">{{ edge }}</li>
            {% endfor %}
            </ul>
        </li>
    {% endfor %}
    </ul>
    {% else %}
    <p><em>No communications detected.</em></p>
    {% endif %}

    <p>
        <a href="/upload">⬅ Upload another PCAP</a>
    </p>
    <p>
        <a href="/upload/firewall.csv?bus_id={{ request.query_params.bus_id }}">
            ⬇ Download firewall rules (CSV)
        </a>
    </p>
</body>
{% endblock %}
